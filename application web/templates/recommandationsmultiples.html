{% extends "projet_layout.html" %}

{% block titre %}
    Recommandations Multiples - Hackathon Spotify
{% endblock %}
{% block title %}
    Recommandations Multiples
{% endblock %}
{% block body %}
<section id="recommendation">
    <div class="inner">
        <h2>Recommandations de musique à partir des playlists</h2>

        <!-- Formulaire pour ajouter une musique à la playlist temporaire -->
        <h3>Ajouter une musique à la playlist temporaire</h3>
        <form method="POST" action="/recommandationsmultiples">
            <input type="hidden" name="action" value="add_to_temporary_playlist">
            <label for="music_name">Nom de la musique :</label><br>
            <input type="text" id="music_name" name="music_name" placeholder="Entrez le nom de la musique" 
                   oninput="fetchSuggestions()" autocomplete="off" required>
            <ul id="suggestions" style="border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none;"></ul>
            <button type="submit" class="bouton">Ajouter</button>
        </form>

        <!-- Playlist temporaire -->
        {% if temporary_playlist_details %}
            <h3>Playlist temporaire</h3>
            <ul>
                {% for music in temporary_playlist_details %}
                    <li>{{ music.title }} - {{ music.artists | join(", ") }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <!-- Formulaire pour obtenir des recommandations -->
        {% if user_connected %}
            <h3>Sélectionnez des playlists personnelles</h3>
            <form method="POST" action="/recommandationsmultiples">
                <input type="hidden" name="action" value="get_recommendations">
                <label for="playlist_ids">Sélectionnez vos playlists :</label><br>
                <select id="playlist_ids" name="playlist_ids" multiple>
                    {% for playlist in playlists %}
                        <option value="{{ playlist.music_id }}">{{ playlist.title }}</option>
                    {% endfor %}
                </select>
                <br>
                <button type="submit" class="bouton">Obtenir Recommandations</button>
            </form>
        {% else %}
            <p>Connectez-vous pour sélectionner vos playlists personnelles.</p>
        {% endif %}

        <!-- Recommandations -->
        {% if recommandations %}
            <h3>Recommandations :</h3>
            <ul id="user-music-list" style="list-style: none; padding: 0;">
                {% for music in recommandations %}
                    <li style="margin-bottom: 20px;">
                        {% if music.cover_url %}
                            <img src="{{ music.cover_url }}" alt="Album cover" style="width: 100px; height: 100px; object-fit: cover;">
                        {% endif %}
                        <div>
                            <strong>{{ music.title }}</strong> - {{ music.artists | join(", ") }}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
</section>
{% endblock %}


<script>
    function fetchSuggestions() {
        const input = document.getElementById('music_name');
        const suggestionsList = document.getElementById('suggestions');
        const query = input.value.trim();
    
        if (query.length === 0) {
            suggestionsList.style
            suggestionsList.style.display = 'none';
            suggestionsList.innerHTML = '';
            return;
        }
    
        fetch(`/api/search_music?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionsList.innerHTML = ''; // Clear previous suggestions
    
                if (data.length === 0) {
                    suggestionsList.style.display = 'none';
                    return;
                }
    
                data.forEach(music => {
                    const li = document.createElement('li');
                    li.textContent = `${music.title} - ${music.artists.join(', ')}`;
                    li.style.cursor = 'pointer';
                    li.onclick = () => {
                        input.value = music.title;
                        suggestionsList.style.display = 'none';
                    };
                    suggestionsList.appendChild(li);
                });
    
                suggestionsList.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                suggestionsList.style.display = 'none';
            });
    }

    function playMusic(trackUri, deviceId = null) {
        fetch('/play_music', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                track_uri: trackUri,
                device_id: deviceId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Erreur : " + data.error);
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Erreur réseau :', error));
    }

    function stopMusic() {
        fetch('/stop_music', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Erreur : " + data.error);
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Erreur réseau :', error));
    }
</script>
<script>
    function addToProfile(musicId) {
        fetch('/api/add_music', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                
            },
            body: JSON.stringify({ music_id: musicId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Musique ajoutée : ${data.message}`);
            } else {
                alert(`Erreur : ${data.message}`);
            }
        })
        .catch(error => console.error('Erreur :', error));
    }
</script>